<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å¯¹å†²ç›ˆäºè®¡ç®—å™¨ï¼ˆæ”¯æŒæ‰‹åŠ¨ä»·å·®ï¼‰</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    .green { color: green; font-weight: bold; }
    .red { color: red; font-weight: bold; }
  </style>
</head>
<body>

<h2>å¯¹å†²ç›ˆäºè®¡ç®—å™¨ï¼ˆæ”¯æŒæ‰‹åŠ¨æœ€å°ä»·å·®ï¼‰</h2>

<label>å¼€ä»“ä»·æ ¼ï¼ˆUSDï¼‰: <input type="number" id="priceOpen" value="91360.5"></label><br><br>
<label>å¹³ä»“ä»·æ ¼ï¼ˆUSDï¼‰: <input type="number" id="priceClose" value="92004.7"></label><br><br>
<label>æ–¹å‘:
  <select id="direction">
    <option value="long">å¤š</option>
    <option value="short">ç©º</option>
  </select>
</label><br><br>
<label>æ•°é‡ï¼ˆBTCï¼‰: <input type="number" id="amount" value="0.001"></label><br><br>
<label>æ æ†å€æ•°: <input type="number" id="leverage" value="125"></label><br><br>
<label>æ‰‹ç»­è´¹ï¼ˆ%ï¼‰: <input type="number" id="feeRate" value="0.06" step="0.01"></label><br><br>
<label>æ‰‹ç»­è´¹è¿”ä½£ï¼ˆ%ï¼‰: <input type="number" id="rebate" value="82" step="1"></label><br><br>

<label>æœ€å°ç›ˆåˆ©ä»·å·®ï¼ˆUSDï¼‰: <input type="number" id="manualSpread" step="0.0001"></label>
<small>ï¼ˆå¯æ‰‹åŠ¨è°ƒæ•´ï¼Œé»˜è®¤ç”±ç³»ç»Ÿè®¡ç®—ï¼‰</small><br><br>

<button onclick="calculate()">è®¡ç®—</button>

<h3>äº¤æ˜“æ˜ç»†ï¼ˆå«å¯¹å†²æ¨¡æ‹Ÿï¼‰ï¼š</h3>
<table id="recordTable">
  <thead>
    <tr>
      <th>å¼€/å¹³</th>
      <th>æ–¹å‘</th>
      <th>æˆäº¤ä»·</th>
      <th>å¹³ä»“ä»·</th>
      <th>æ•°é‡</th>
      <th>æ æ†</th>
      <th>æµ®åŠ¨ç›ˆäº</th>
      <th>æ‰‹ç»­è´¹æˆæœ¬</th>
      <th>è¿”ä½£æ”¶å…¥</th>
      <th>å®é™…ç›ˆäºï¼ˆä¸å«è¿”ä½£ï¼‰</th>
      <th>å®é™…ç›ˆäºï¼ˆå«è¿”ä½£ï¼‰</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<h3>æœ¬æ¬¡å¯¹å†²ç›ˆäºæ±‡æ€»ï¼š</h3>
<div id="summary"></div>
<script>
function formatProfit(value) {
  const num = value.toFixed(6);
  if (value > 0) return `<span class="green">+${num}</span>`;
  if (value < 0) return `<span class="red">${num}</span>`;
  return num;
}

function calculate() {
  const priceOpen = parseFloat(document.getElementById("priceOpen").value);
  const priceClose = parseFloat(document.getElementById("priceClose").value);
  const amount = parseFloat(document.getElementById("amount").value);
  const feeRate = parseFloat(document.getElementById("feeRate").value) / 100;
  const rebate = parseFloat(document.getElementById("rebate").value) / 100;
  const leverage = parseFloat(document.getElementById("leverage").value);
  const direction = document.getElementById("direction").value;

  const posValue = priceOpen * amount;
  const rawFee = posValue * feeRate;
  const rebateFee = rawFee * rebate;
  const actualFee = rawFee - rebateFee;
  const totalFee = actualFee * 2;
  const totalRawFee = rawFee * 2;
  const totalRebate = rebateFee * 2;

  // è®¡ç®—é»˜è®¤æœ€å°ç›ˆåˆ©ä»·å·®
  const calculatedSpread = priceOpen * feeRate * 2 * (1 - rebate);
  const spreadInput = document.getElementById("manualSpread");

  // å¦‚æœç”¨æˆ·æ²¡å¡«ï¼Œè‡ªåŠ¨å¡«å…¥ç³»ç»Ÿæ¨èå€¼
  if (!spreadInput.value) {
    spreadInput.value = calculatedSpread.toFixed(6);
  }

  // æœ€ç»ˆä½¿ç”¨çš„ä»·å·®å€¼
  const minSpread = parseFloat(spreadInput.value);

  const tbody = document.querySelector("#recordTable tbody");
  tbody.innerHTML = "";

  // æ¨¡æ‹ŸæŒä»“
  const floatPnL = direction === 'long'
    ? (priceClose - priceOpen) * amount
    : (priceOpen - priceClose) * amount;
  const netPnL_noRebate = floatPnL - totalRawFee;
  const netPnL_withRebate = floatPnL - totalRawFee + totalRebate;

  // æ¨¡æ‹Ÿå¯¹å†²
  const hedgeOpen = direction === 'long'
    ? priceOpen + minSpread
    : priceOpen - minSpread;
  const hedgeFloatPnL = direction === 'long'
    ? (hedgeOpen - priceClose) * amount
    : (priceClose - hedgeOpen) * amount;
  const hedgeNet_noRebate = hedgeFloatPnL - totalRawFee;
  const hedgeNet_withRebate = hedgeFloatPnL - totalRawFee + totalRebate;

  const renderRow = (label, dir, open, close, floatPnL, net1, net2) => {
    tbody.innerHTML += `
      <tr>
        <td>${label}</td>
        <td>${dir}</td>
        <td>${open.toFixed(2)}</td>
        <td>${close.toFixed(2)}</td>
        <td>${amount}</td>
        <td>${leverage}x</td>
        <td>${formatProfit(floatPnL)}</td>
        <td>-${totalRawFee.toFixed(6)}</td>
        <td>+${totalRebate.toFixed(6)}</td>
        <td>${formatProfit(net1)}</td>
        <td>${formatProfit(net2)}</td>
      </tr>
    `;
  };

  renderRow("æ¨¡æ‹ŸæŒä»“", direction === 'long' ? 'å¤š' : 'ç©º', priceOpen, priceClose, floatPnL, netPnL_noRebate, netPnL_withRebate);
  renderRow("æ¨¡æ‹Ÿå¯¹å†²", direction === 'long' ? 'ç©º' : 'å¤š', hedgeOpen, priceClose, hedgeFloatPnL, hedgeNet_noRebate, hedgeNet_withRebate);

  // å¯¹å†²æ“ä½œæ±‡æ€»åˆ©æ¶¦ï¼ˆç”¨æ¨¡æ‹Ÿå¯¹å†²å•ï¼‰
const summaryProfitNoRebate = hedgeNet_noRebate + netPnL_noRebate;
const summaryProfitWithRebate = hedgeNet_withRebate + netPnL_withRebate;

const totalMargin = priceOpen * amount * 2 / leverage; // æ€»ä¿è¯é‡‘ï¼ˆå¯¹å†²æ˜¯åŒè¾¹ï¼‰
const profitRateNoRebate = (summaryProfitNoRebate / totalMargin) * 100;
const profitRateWithRebate = (summaryProfitWithRebate / totalMargin) * 100;

document.getElementById("summary").innerHTML = `
  <table>
    <tr><th>é¡¹ç›®</th><th>å€¼</th></tr>
    <tr><td>ğŸ’° å¯¹å†²åˆ©æ¶¦ï¼ˆä¸å«è¿”ä½£ï¼‰</td><td>${formatProfit(summaryProfitNoRebate)} USDT</td></tr>
    <tr><td>ğŸ’° å¯¹å†²åˆ©æ¶¦ï¼ˆå«è¿”ä½£ï¼‰</td><td>${formatProfit(summaryProfitWithRebate)} USDT</td></tr>
    <tr><td>ğŸ“ˆ å¯¹å†²åˆ©æ¶¦ç‡ï¼ˆä¸å«è¿”ä½£ï¼‰</td><td>${profitRateNoRebate.toFixed(4)}%</td></tr>
    <tr><td>ğŸ“ˆ å¯¹å†²åˆ©æ¶¦ç‡ï¼ˆå«è¿”ä½£ï¼‰</td><td>${profitRateWithRebate.toFixed(4)}%</td></tr>
  </table>
`;
}
</script>

</body>
</html>
